anchors:
  - auto-retry: &auto-retry
      automatic:
        # Agent terminated because the AWS EC2 spot instance killed by AWS.
        - signal_reason: agent_stop
          limit: 3
        - exit_status: -1
          signal_reason: none
          limit: 3
  - plugins:
    # we need to override args, so didn't include image here in the anchor
    - docker-compose: &docker-compose
        run: rw-build-env
        config: ci/docker-compose.yml
        mount-buildkite-agent: true
        propagate-environment: true

other-sql-backend: &other-sql-backend
  matrix:
    setup:
      label: [""]
      endpoint: [""]
    adjustments:
      - with:
          label: ""
          endpoint: ""
        skip: true # hack
      - with:
          label: "postgres"
          # PGPASSWORD=postgres psql -h db -p 5432 -U postgres -d rwmeta
          endpoint: "postgres://postgres:post\\tgres@db:5432/rwmeta"
      - with:
          label: "mysql"
          # mysql -h mysql-meta -P 3306 -u root -p123456 -D rwmeta
          endpoint: "mysql://root:123456@mysql-meta:3306/rwmeta"
  env:
    RISEDEV_SQL_ENDPOINT: "{{matrix.endpoint}}"


steps:
  - label: "check ci image rebuild"
    plugins:
      - monorepo-diff#v1.2.0:
          diff: "git diff --name-only origin/main"
          watch:
            - path: "ci/.env"
              config:
                command: "ci/build-ci-image.sh"
                label: "ci build images"
            - path: "ci/build-ci-image.sh"
              config:
                command: "ci/build-ci-image.sh"
                label: "ci build images"
  - wait

  - label: "build"
    command: "ci/scripts/build.sh -p ci-dev"
    key: "build"
    plugins:
      - docker-compose#v5.5.0: *docker-compose
    timeout_in_minutes: 120
    retry: *auto-retry